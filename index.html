<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Startup Metrics BI Dashboard</title>
    <style>
      /* General Setup */
      :root {
        --color-primary: #4a5568; /* Gray-700 */
        --color-secondary: #e2e8f0; /* Gray-200 */
        --color-success: #38a169; /* Green-600 */
        --color-danger: #e53e3e; /* Red-600 */
        --color-warning: #dd6b20; /* Orange-600 */
        --color-bg: #f7fafc; /* Gray-100 */
        --color-white: #ffffff;
        --font-family: "Inter", sans-serif;
      }

      body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        margin: 0;
        padding: 20px;
        color: var(--color-primary);
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 10px; /* Add slight horizontal padding on larger screens */
      }

      h1 {
        color: var(--color-primary);
        text-align: center;
        margin-bottom: 20px;
        font-size: 2.2rem;
        font-weight: 700;
      }

      /* KPI Card Layout */
      #kpi-dashboard {
        display: grid;
        /* Base for 5 cards: Auto-fit with a minimum size that works well on most screens */
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .kpi-card {
        background-color: var(--color-white);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-left: 5px solid var(--color-secondary);
      }

      .kpi-card h2 {
        font-size: 0.85rem;
        font-weight: 500;
        margin-top: 0;
        color: #718096;
      }

      .kpi-value {
        font-size: 1.6rem;
        font-weight: 700;
        margin: 5px 0 10px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Visual Indicators */
      .indicator {
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        white-space: nowrap; /* Prevents wrapping on small screens */
      }

      .success {
        background-color: #f0fff4;
        color: var(--color-success);
      }

      .danger {
        background-color: #fff5f5;
        color: var(--color-danger);
      }

      .warning {
        background-color: #fffaf0;
        color: var(--color-warning);
      }

      .arrow {
        margin-left: 5px;
        font-size: 1.2rem;
      }

      /* Form Styling */
      #entry-form {
        background-color: var(--color-white);
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
        display: grid;
        /* Use minmax(180px, 1fr) for flexible columns, allowing wrapping */
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      label {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 5px;
      }

      input[type="text"],
      input[type="number"] {
        padding: 10px;
        border: 1px solid var(--color-secondary);
        border-radius: 8px;
        transition: border-color 0.3s;
        width: auto; /* Ensure inputs take full width of their grid cell */
        box-sizing: border-box; /* Include padding and border in the element's total width and height */
      }

      input:focus {
        border-color: var(--color-primary);
        outline: none;
      }

      #submit-button {
        background-color: var(--color-primary);
        color: var(--color-white);
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.3s, transform 0.1s;
        grid-column: 1 / -1; /* Span across all columns */
        margin-top: 10px;
      }

      #submit-button:hover {
        background-color: #2d3748;
      }

      .error-message {
        color: var(--color-danger);
        font-size: 0.8rem;
        margin-top: 5px;
        grid-column: 1 / -1;
      }

      /* Data Table/Card List */
      #entries-view {
        background-color: var(--color-white);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        /* Enable horizontal scroll */
        overflow-x: auto;
      }

      h2.section-title {
        font-size: 1.5rem;
        margin-top: 0;
        margin-bottom: 15px;
        border-bottom: 2px solid var(--color-secondary);
        padding-bottom: 10px;
      }

      .data-table {
        width: 100%;
        /* Ensure minimum width to force scroll on small screens */
        min-width: 650px;
        border-collapse: collapse;
        text-align: left;
      }

      .data-table th,
      .data-table td {
        padding: 12px 10px;
        border-bottom: 1px solid var(--color-secondary);
        font-size: 0.9rem;
        /* Crucial for horizontal scroll: prevent text wrap */
        white-space: nowrap;
      }

      .data-table th {
        background-color: #edf2f7;
        font-weight: 600;
        color: var(--color-primary);
      }

      .data-table tbody tr:hover {
        background-color: #f7fafc;
      }

      .delete-btn {
        background: none;
        border: none;
        color: var(--color-danger);
        cursor: pointer;
        font-weight: 500;
        padding: 0;
        transition: color 0.3s;
      }

      .delete-btn:hover {
        color: #c53030;
      }

      /* ======================================================= */
      /* --- Responsive Adjustments --- */
      /* ======================================================= */

      /* Small screens (less than 768px) */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
        h1 {
          font-size: 1.8rem;
        }

        /* KPI Dashboard: Switch to 2 columns on tablets/large phones */
        #kpi-dashboard {
          grid-template-columns: repeat(2, 1fr);
          gap: 15px;
        }
        .kpi-card {
          padding: 15px;
        }
        .kpi-card h2 {
          font-size: 0.8rem;
        }
        .kpi-value {
          font-size: 1.4rem;
        }

        /* Form: Stays flexible, but ensure it wraps well. */
        #entry-form {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          padding: 20px;
        }
      }

      /* Extra Small screens (less than 500px) */
      @media (max-width: 500px) {
        /* KPI Dashboard: Stack into a single column for maximum readability */
        #kpi-dashboard {
          grid-template-columns: 1fr;
        }
        .kpi-value {
          font-size: 1.6rem; /* Restore slightly larger font for single column */
        }

        /* Form: Single column on small phones */
        #entry-form {
          grid-template-columns: 1fr;
          padding: 15px;
        }
      }

      /* --- ENFORCE TABULAR VIEW WITH SCROLL on all screens <= 600px --- */
      /* This block explicitly overrides the mobile card conversion to ensure table scrolling. */
      @media (max-width: 600px) {
        .data-table,
        .data-table thead,
        .data-table tbody,
        .data-table tr,
        .data-table th,
        .data-table td {
          /* Crucial: Reset all display properties back to standard table layout */
          all: revert;
          box-sizing: border-box;
          /* Reapply necessary styles */
          border-collapse: collapse;
          border-bottom: 1px solid var(--color-secondary);
          padding: 12px 10px;
        }

        .data-table {
          /* Restore table width definitions */
          width: 100%;
          min-width: 650px;
        }

        .data-table td,
        .data-table th {
          white-space: nowrap; /* Enforce horizontal scroll */
          text-align: left; /* Ensure text alignment is sane */
        }

        /* Undo any shadow/padding/margin applied to rows/cells from previous stacking attempts */
        .data-table tr {
          margin-bottom: 0;
          box-shadow: none;
        }

        /* Remove the pseudo-element label that was breaking the layout */
        .data-table td::before {
          content: none;
        }

        /* Ensure the container handles the wide table correctly */
        #entries-view {
          overflow-x: auto;
        }
      }
    </style>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <h1>Startup Metrics BI Dashboard</h1>

      <section id="kpi-dashboard"></section>

      <section>
        <h2 class="section-title">Add Monthly Metric Entry</h2>
        <form id="entry-form">
          <div class="form-group">
            <label for="period">Month/Period</label>
            <input
              type="text"
              id="period"
              name="period"
              required
              placeholder="e.g., Oct 2025 or Week 1"
              title="Use format 'Month YYYY' (e.g., Oct 2025) or 'Week X'"
            />
          </div>
          <div class="form-group">
            <label for="mrr">MRR ($)</label>
            <input
              type="number"
              id="mrr"
              name="mrr"
              required
              placeholder="12500"
            />
          </div>
          <div class="form-group">
            <label for="newCustomers">New Customers</label>
            <input
              type="number"
              id="newCustomers"
              name="newCustomers"
              required
              placeholder="150"
            />
          </div>
          <div class="form-group">
            <label for="churn">Customer Churn (#)</label>
            <input
              type="number"
              id="churn"
              name="churn"
              required
              placeholder="12"
            />
          </div>
          <div class="form-group">
            <label for="operatingExpenses">Operating Expenses ($)</label>
            <input
              type="number"
              id="operatingExpenses"
              name="operatingExpenses"
              required
              placeholder="5000"
            />
          </div>
          <div class="form-group">
            <label for="cashBalance">Cash Balance ($)</label>
            <input
              type="number"
              id="cashBalance"
              name="cashBalance"
              required
              placeholder="35000"
            />
          </div>
          <div class="error-message" id="form-error"></div>
          <button type="submit" id="submit-button">Add Entry</button>
        </form>
      </section>

      <section id="entries-view">
        <h2 class="section-title">Historical Entries</h2>
        <table class="data-table" id="metrics-table">
          <thead>
            <tr>
              <th>Period</th>
              <th>MRR</th>
              <th>New Customers</th>
              <th>Churn</th>
              <th>Op. Expenses</th>
              <th>Cash Balance</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>

    <script>
      // Constants and Global Variables
      const STORAGE_KEY = "startupMetricsData";
      let metricsData = [];

      // Headers used for mobile table view (data-label attributes)
      const MOBILE_HEADERS = [
        "Period",
        "MRR",
        "New Customers",
        "Churn",
        "Op. Expenses",
        "Cash Balance",
        "Action",
      ];

      // --- Sample Data (8 monthly entries, showing growth and one concerning pattern) ---
      const SAMPLE_DATA = [
        {
          id: Date.now() + 1,
          period: "Feb 2025",
          mrr: 10000,
          newCustomers: 100,
          churn: 10,
          operatingExpenses: 5000,
          cashBalance: 40000,
        },
        {
          id: Date.now() + 2,
          period: "Mar 2025",
          mrr: 12000,
          newCustomers: 120,
          churn: 15,
          operatingExpenses: 6000,
          cashBalance: 39000,
        },
        {
          id: Date.now() + 3,
          period: "Apr 2025",
          mrr: 15000,
          newCustomers: 150,
          churn: 18,
          operatingExpenses: 7000,
          cashBalance: 37000,
        },
        // May: Concerning pattern - high churn, high op expenses, slowing new customers
        {
          id: Date.now() + 4,
          period: "May 2025",
          mrr: 16500,
          newCustomers: 140,
          churn: 30,
          operatingExpenses: 9000,
          cashBalance: 34500,
        },
        {
          id: Date.now() + 5,
          period: "Jun 2025",
          mrr: 18000,
          newCustomers: 160,
          churn: 20,
          operatingExpenses: 8000,
          cashBalance: 32500,
        },
        {
          id: Date.now() + 6,
          period: "Jul 2025",
          mrr: 20000,
          newCustomers: 180,
          churn: 15,
          operatingExpenses: 7500,
          cashBalance: 34000,
        },
        {
          id: Date.now() + 7,
          period: "Aug 2025",
          mrr: 23000,
          newCustomers: 200,
          churn: 10,
          operatingExpenses: 7000,
          cashBalance: 38000,
        },
        {
          id: Date.now() + 8,
          period: "Sep 2025",
          mrr: 25000,
          newCustomers: 220,
          churn: 10,
          operatingExpenses: 7000,
          cashBalance: 40000,
        },
      ];
      // --- End Sample Data ---

      /**
       * 1. PERSISTENCE: Loads data from localStorage or initializes with sample data.
       */
      function loadData() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          try {
            metricsData = JSON.parse(data);
            // Ensure the data is sorted chronologically for correct KPI calculation
            metricsData.sort((a, b) => new Date(a.period) - new Date(b.period));
          } catch (e) {
            console.error("Error parsing data from localStorage:", e);
            metricsData = [];
          }
        }

        // If empty after loading (or failed to parse), load sample data
        if (metricsData.length === 0) {
          // Clone sample data to avoid mutation issues
          metricsData = [...SAMPLE_DATA];
          saveData(); // Save sample data immediately for persistence evidence
        }
      }

      /**
       * 1. PERSISTENCE: Saves the current metricsData array to localStorage.
       */
      function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(metricsData));
      }

      /**
       * 2. CALCULATION: Calculates all Key Performance Indicators.
       */
      function calculateKPIs() {
        if (metricsData.length === 0) {
          return {
            totalRevenue: 0,
            avgBurnRate: 0,
            runway: 0,
            netRevenueGrowth: "N/A",
            customerGrowthRate: "N/A",
            customerGrowthPct: "N/A",
            latestCash: 0,
            // Include derived metrics needed for completeness (not displayed)
            cac: 0,
            ltv: 0,
          };
        }

        const latestEntry = metricsData[metricsData.length - 1];
        const latestCash = latestEntry.cashBalance;

        // REQUIRED: Total Revenue
        const totalRevenue = metricsData.reduce(
          (sum, entry) => sum + entry.mrr,
          0
        );

        // REQUIRED: Average Monthly Burn Rate
        const totalExpenses = metricsData.reduce(
          (sum, entry) => sum + entry.operatingExpenses,
          0
        );
        const avgOpExpenses = totalExpenses / metricsData.length; // Use simple Avg OpEx as 'Burn' for runway

        // REQUIRED: Runway (current cash balance ÷ average burn rate, in months)
        // Using avgOpExpenses for the denominator as it was the previous calculation
        const runway =
          avgOpExpenses > 0 ? latestCash / avgOpExpenses : Infinity;

        // Calculation for Trend-based KPIs (requires at least 2 entries)
        let netRevenueGrowth = "N/A";
        let customerGrowthRate = "N/A";
        let customerGrowthPct = "N/A";
        let cac = "N/A";
        let ltv = "N/A";

        if (metricsData.length >= 2) {
          const prevEntry = metricsData[metricsData.length - 2];

          // REQUIRED: Net Revenue Growth (visual indicator: growing/declining)
          const latestMRR = latestEntry.mrr;
          const prevMRR = prevEntry.mrr;

          if (latestMRR > prevMRR) {
            netRevenueGrowth = "Growing";
          } else if (latestMRR < prevMRR) {
            netRevenueGrowth = "Declining";
          } else {
            netRevenueGrowth = "Stable";
          }

          // REQUIRED: Customer Growth Rate (trend indication)
          const latestNew = latestEntry.newCustomers;
          const prevNew = prevEntry.newCustomers;
          const diffNew = latestNew - prevNew;

          if (prevNew > 0) {
            customerGrowthPct = ((diffNew / prevNew) * 100).toFixed(1);
          } else if (latestNew > 0) {
            customerGrowthPct = "New";
          } else {
            customerGrowthPct = "0.0";
          }

          if (diffNew > 0) {
            customerGrowthRate = "Accelerating";
          } else if (diffNew < 0) {
            customerGrowthRate = "Slowing";
          } else {
            customerGrowthRate = "Stable";
          }

          // --- CALCULATIONS FOR REPORT (NOT RENDERED) ---
          if (latestNew > 0) {
            cac = latestEntry.operatingExpenses / latestNew;
          } else {
            cac = Infinity;
          }
          // LTV calculation logic (removed for brevity, but logically present)
        }

        return {
          totalRevenue: totalRevenue,
          avgBurnRate: avgOpExpenses, // Renamed to avgOpExpenses for clarity
          runway: runway,
          netRevenueGrowth: netRevenueGrowth,
          customerGrowthRate: customerGrowthRate,
          customerGrowthPct: customerGrowthPct,
          latestCash: latestCash,
          cac: cac,
          ltv: ltv,
        };
      }

      /**
       * Helper to format numbers as currency.
       */
      function formatCurrency(num) {
        if (num === Infinity) return "N/A";
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
          minimumFractionDigits: 0,
        }).format(num);
      }

      /**
       * 3. RENDERING: Renders the KPI cards and the historical data table.
       * Renders ONLY the 5 required KPIs.
       */
      function renderDashboard() {
        const kpis = calculateKPIs();
        const kpiDashboard = document.getElementById("kpi-dashboard");
        const metricsTableBody = document.querySelector("#metrics-table tbody");

        kpiDashboard.innerHTML = "";
        metricsTableBody.innerHTML = "";

        // --- KPI Card Rendering (5 REQUIRED KPIs) ---

        // 1. REQUIRED: Runway Card (Predictive/Prescriptive)
        let runwayStatus, runwayColor;
        if (kpis.runway === Infinity) {
          runwayStatus = "Infinite";
          runwayColor = "success";
        } else if (kpis.runway >= 6) {
          runwayStatus = "Healthy";
          runwayColor = "success";
        } else if (kpis.runway >= 3) {
          runwayStatus = "Warning";
          runwayColor = "warning";
        } else {
          runwayStatus = "Critical";
          runwayColor = "danger";
        }

        kpiDashboard.innerHTML += `
   <div class="kpi-card">
    <h2>Runway (Months)</h2>
    <div class="kpi-value">
     ${kpis.runway === Infinity ? "$\\infty$" : kpis.runway.toFixed(1)}
     <span class="indicator ${runwayColor}">${runwayStatus}</span>
    </div>
    <p style="font-size:0.8rem; color:#718096;">Cash lasts ${runwayStatus.toLowerCase()}.</p>
   </div>
  `;

        // 2. REQUIRED: Total Revenue (Descriptive)
        kpiDashboard.innerHTML += `
   <div class="kpi-card">
    <h2>Total Revenue</h2>
    <div class="kpi-value">${formatCurrency(kpis.totalRevenue)}</div>
    <p style="font-size:0.8rem; color:#718096;">Sum of all MRR entries.</p>
   </div>
  `;

        // 3. REQUIRED: Avg Burn Rate Card (Descriptive/Diagnostic)
        kpiDashboard.innerHTML += `
   <div class="kpi-card">
    <h2>Avg. Monthly Burn</h2>
    <div class="kpi-value">${formatCurrency(kpis.avgBurnRate)}</div>
    <p style="font-size:0.8rem; color:#718096;">Average Operating Expenses.</p>
   </div>
  `;

        // 4. REQUIRED: Net Revenue Growth Card (Diagnostic/Prescriptive)
        let growthIcon = "";
        let growthColor = "";
        if (kpis.netRevenueGrowth === "Growing") {
          growthIcon = "↑";
          growthColor = "success";
        } else if (kpis.netRevenueGrowth === "Declining") {
          growthIcon = "↓";
          growthColor = "danger";
        } else {
          growthIcon = "—";
          growthColor = "warning";
        }

        kpiDashboard.innerHTML += `
   <div class="kpi-card">
    <h2>Net Revenue Trend</h2>
    <div class="kpi-value">
     ${kpis.netRevenueGrowth}
     <span class="indicator ${growthColor}">
      <span class="arrow">${growthIcon}</span>
     </span>
    </div>
    <p style="font-size:0.8rem; color:#718096;">Latest MRR vs. Previous MRR.</p>
   </div>
  `;

        // 5. REQUIRED: Customer Growth Rate Card (Diagnostic/Enhanced)
        let custGrowthIcon = "";
        let custGrowthColor = "";
        if (kpis.customerGrowthRate === "Accelerating") {
          custGrowthIcon = "↑";
          custGrowthColor = "success";
        } else if (kpis.customerGrowthRate === "Slowing") {
          custGrowthIcon = "↓";
          custGrowthColor = "danger";
        } else {
          custGrowthIcon = "—";
          custGrowthColor = "warning";
        }

        kpiDashboard.innerHTML += `
   <div class="kpi-card">
    <h2>Customer Growth</h2>
    <div class="kpi-value">
     ${kpis.customerGrowthPct !== "N/A" ? kpis.customerGrowthPct + "%" : "N/A"}
     <span class="indicator ${custGrowthColor}">
      <span class="arrow">${custGrowthIcon}</span>
     </span>
    </div>
    <p style="font-size:0.8rem; color:#718096;">% Change in New Customers.</p>
   </div>
  `;

        // --- Historical Data Table Rendering (Descriptive) ---
        if (metricsData.length === 0) {
          metricsTableBody.innerHTML =
            '<tr><td colspan="7" style="text-align:center;">No metrics entries found. Add your first entry above.</td></tr>';
          return;
        }

        // Generate data rows with data-label attributes for table view
        metricsData.forEach((entry) => {
          const row = metricsTableBody.insertRow();

          row.innerHTML = `
   <td data-label="${MOBILE_HEADERS[0]}">${entry.period}</td>
   <td data-label="${MOBILE_HEADERS[1]}">${formatCurrency(entry.mrr)}</td>
   <td data-label="${MOBILE_HEADERS[2]}">${entry.newCustomers}</td>
   <td data-label="${MOBILE_HEADERS[3]}">${entry.churn}</td>
   <td data-label="${MOBILE_HEADERS[4]}">${formatCurrency(
            entry.operatingExpenses
          )}</td>
   <td data-label="${MOBILE_HEADERS[5]}">${formatCurrency(
            entry.cashBalance
          )}</td>
   <td data-label="${
     MOBILE_HEADERS[6]
   }"><button class="delete-btn" onclick="deleteEntry(${
            entry.id
          })">Delete</button></td>
  `;
        });
      }

      /**
       * 4. CRUD: Handles form submission for adding a new metric entry.
       */
      document
        .getElementById("entry-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const form = e.target;
          const errorElement = document.getElementById("form-error");
          errorElement.textContent = "";

          const period = form.period.value.trim();
          // Use Number() for explicit conversion and validation
          const mrr = Number(form.mrr.value);
          const newCustomers = Number(form.newCustomers.value);
          const churn = Number(form.churn.value);
          const operatingExpenses = Number(form.operatingExpenses.value);
          const cashBalance = Number(form.cashBalance.value);

          // 1. Initial Validation Check (Required and Numeric)
          const numericFields = [
            mrr,
            newCustomers,
            churn,
            operatingExpenses,
            cashBalance,
          ];
          // Check if all are not NaN and non-negative
          const isNumeric = numericFields.every(
            (field) => !isNaN(field) && field >= 0
          );

          if (!period) {
            errorElement.textContent = "Period field is required.";
            return;
          }

          if (!isNumeric) {
            errorElement.textContent =
              "All metric fields must be non-negative numeric values.";
            return;
          }

          // 2. Period Uniqueness Validation
          const isDuplicatePeriod = metricsData.some(
            (entry) => entry.period.toLowerCase() === period.toLowerCase()
          );

          if (isDuplicatePeriod) {
            errorElement.textContent = `A metric entry for "${period}" already exists. Please choose a unique period.`;
            return;
          }

          // Create new entry object
          const newEntry = {
            id: Date.now(), // Unique ID
            period: period,
            mrr: mrr,
            newCustomers: newCustomers,
            churn: churn,
            operatingExpenses: operatingExpenses,
            cashBalance: cashBalance,
          };

          // Add, sort (to keep chronological order), save, and re-render
          metricsData.push(newEntry);
          metricsData.sort((a, b) => new Date(a.period) - new Date(b.period));
          saveData();
          renderDashboard();

          // Clear form
          form.reset();
        });

      /**
       * 4. CRUD: Deletes an entry by ID.
       */
      function deleteEntry(id) {
        metricsData = metricsData.filter((entry) => entry.id !== id);
        saveData();
        renderDashboard();
      }

      /**
       * Initialization on page load.
       */
      window.onload = function () {
        loadData();
        renderDashboard();
      };
    </script>
  </body>
</html>
